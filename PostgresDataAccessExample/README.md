# Обзор проекта PostgresDataAccessExample

Этот проект представляет собой консольное приложение на .NET, демонстрирующее лучшие практики работы с базой данных PostgreSQL. Он включает в себя базовые CRUD-операции, обработку транзакций, а также использование расширенной функции PostgreSQL `LISTEN`/`NOTIFY` для получения уведомлений от базы данных в реальном времени.

## Структура проекта

```
/PostgresDataAccessExample
├── Data/
│   ├── DbConnectionFactory.cs  # (РЕФАКТОРИНГ) Фабрика для создания подключений к БД.
│   ├── DbContext.cs            # Основной класс для взаимодействия с БД (выполнение запросов).
│   └── ...
├── Services/
│   ├── NotificationService.cs  # Сервис для прослушивания уведомлений от БД.
│   └── ...
├── Setup/
│   ├── DatabaseSetup.cs        # Класс для начальной настройки БД (создание триггеров).
│   └── ...
├── appsettings.json            # Файл конфигурации (строка подключения).
└── Program.cs                  # Точка входа в приложение.
```

### Подробное описание компонентов

#### `Data/DbConnectionFactory.cs`
- **Назначение**: Централизованное управление созданием подключений к базе данных.
- **Логика**: Читает строку подключения из `appsettings.json` и предоставляет метод `CreateConnection()` для создания и открытия нового экземпляра `NpgsqlConnection`.
- **Преимущества**: Упрощает код в других классах и обеспечивает единую точку для управления конфигурацией подключения.

#### `Data/DbContext.cs`
- **Назначение**: Основной шлюз для всех операций с базой данных.
- **Логика**: Использует `DbConnectionFactory` для получения соединений. Предоставляет высокоуровневые методы для выполнения SQL-запросов:
  - `ExecuteQuery()`: для `SELECT` запросов, возвращает `DataSet`.
  - `ExecuteNonQuery()`: для `INSERT`, `UPDATE`, `DELETE`.
  - `ExecuteScalar()`: для получения одного значения.
- **Особенности**: Не содержит логики прямого создания соединений, а делегирует это фабрике.

#### `Services/NotificationService.cs`
- **Назначение**: Демонстрация работы механизма `LISTEN`/`NOTIFY` в PostgreSQL.
- **Логика**: Создает долгоживущее соединение с БД (через `DbConnectionFactory`) и подписывается на канал уведомлений (`new_user_notification`). При получении уведомления, он парсит JSON-нагрузку и выводит информацию в консоль.
- **Особенности**: Работает в фоновом потоке, чтобы не блокировать выполнение основной программы.

#### `Setup/DatabaseSetup.cs`
- **Назначение**: Инкапсуляция логики для первоначальной настройки схемы базы данных.
- **Логика**: Содержит метод `EnsureNotificationTriggerExists()`, который создает в БД специальную функцию и триггер. Этот триггер автоматически отправляет уведомление в канал `new_user_notification` каждый раз, когда в таблицу `users` добавляется новая запись.

#### `Program.cs`
- **Назначение**: Точка входа и оркестратор приложения.
- **Логика**:
  1.  Загружает конфигурацию из `appsettings.json`.
  2.  Инициализирует `DbConnectionFactory`.
  3.  Инициализирует `DbContext` и `NotificationService`, передавая им фабрику.
  4.  Выполняет последовательность демонстрационных действий: тест соединения, создание таблиц, вставка данных, выполнение различных SQL-запросов.
  5.  Запускает `NotificationService` для прослушивания уведомлений.
  6.  Ожидает ввода пользователя для корректного завершения работы.

#### `appsettings.json`
- **Назначение**: Хранение конфигурационных данных.
- **Логика**: Содержит строку подключения `DefaultConnection` к базе данных PostgreSQL. Это позволяет изменять параметры подключения без перекомпиляции приложения.
